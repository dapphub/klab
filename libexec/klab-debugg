#!/usr/bin/env node
const xs = require("xstream").default;
const {run} = require("@cycle/run");
const {docopt} = require("docopt");
const fs = require("fs");
const path = require("path");
const makeConfig = require("../lib/config.js");
process.title = "klab";
// TODO - klab debug should send the config.json to the server

const makeCliDriver = require("../lib/driver/cliDriver.js")
const remoteDriver = require("../lib/driver/remoteDriver.js")
const makeDumpDriver = require("../lib/driver/dumpDriver.js");
const main = require("../lib/main.js")
const {
  testPath,
  revert,
  warn,
  read,
  sha3
} = require("../lib/util.js");

const usage = `
Usage:
  klab debugg [options] <spec>

Options:
  --force               No replay
  --inspect=<id>
  --clean
  --headless
  --filter-oog
  --shamefully-trust-dependencies
`

// const KLAB_OUT = process.env.KLAB_OUT || "out";

const cmd = docopt(usage, {
  argv: ["debugg"].concat(process.argv.slice(2))
});

// const config_json = JSON.parse(fs.readFileSync("./config.json"));
const config      = makeConfig({
  implementations:{},
  name: ""
})

// proof id
config.proofid = cmd['<spec>'];

config.connection = {
  type: "remote",
  host: config.host || "127.0.0.1:8080"
}

const kDriver = remoteDriver(config.connection.host);
// const inspect = cmd["--inspect"];
// if(inspect) config.inspect = inspect;

config.force = cmd["--force"];

const CLIDriver = cmd["--headless"]
  ? () => xs.of()
  : makeCliDriver({
    // type: "console",
    // in: false
  })
config.headless = cmd["--headless"]

const dumpDriver  = makeDumpDriver(config);

const drivers = {
  CLI: CLIDriver,
  K: kDriver,
  Settings: () => xs.of(config),
  Dump: dumpDriver
};

run(main, drivers)
